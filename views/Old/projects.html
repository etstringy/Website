<!DOCTYPE html>
    <head>
        <!-- Primary Meta Tags -->
        <title>Stringy Software</title>
        <meta name="title" content="Stringy Software">
        <meta name="description" content="Software that's Stringy.">

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://stringy.software/">
        <meta property="og:title" content="Stringy Software">
        <meta property="og:description" content="Software that's Stringy.">
        <meta property="og:image" content="assets/banner.png">

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://stringy.software/">
        <meta property="twitter:title" content="Stringy Software">
        <meta property="twitter:description" content="Software that's Stringy.">
        <meta property="twitter:image" content="assets/banner.png">

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="index.css">

        <!-- Materialize -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        
        <!-- JQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

        <!-- Favicon -->
        <link rel="icon" type="image/png" href="assets/favicon.png" />

        <!-- Material Icons -->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- Cookies -->
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

        <!-- SaL2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    </head>
    <body> 
        <nav>
            <div class="nav-wrapper">
                <a href="#" class="brand-logo">Stringy Software</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="/projects.html">Projects</a></li>
                <li id="loginlink"><a href="https://api.stringy.software/auth/login">Login</a></li>
                <li><img id="profile" class="pfp circle" width="50px"></li>
                </ul>
            </div>
        </nav>

            <div class="container">
                <div id="editcont">

                </div>
                <div id="projects" class="row">
                </div>
            </div>
        <script>
            function editprojects() {
                var array = document.getElementsByClassName("card-action")
                for(let i = 0; i < array.length; i++){
                    array[i].insertAdjacentHTML("beforeend", `<a class="red-text lighten-1" href="javascript:removeProject('${array[i].parentElement.children[0].children[1].innerHTML}')">Delete</a>`)
                }
                $("#projects").append('<div class="col s4"><div id="newcard" class="card transparent"><div id="newcont" class="card-content white-text"><span class="card-title">New Project</span><input id="f_name" type="text" class="white_text" placeholder="Name"><input id="f_description" class="white_text" type="text" placeholder="Description"><input id="f_link" class="white_text" type="text" placeholder="URL to project"><input id="f_image" class="white_text" type="text" placeholder="Image URL"></div><div id="newact" class="card-action"><a href="javascript:newProject()">Add</a></div></div></div>')
                $("#editbtn").remove()
            }

            function removeProject(proj) {
                fetch("https://api.stringy.software/database/deleteProject", {
                    method: "post",
                    headers: {
                        "X-DiscordToken": Cookies.get("access_token"),
                        "Content-Type": 'application/json'
                    },
                    "body": JSON.stringify({
                        "projectname": proj
                    })
                })
                .then(res => res.json())
                .then(json => {
                    if(json.status = 200){
                        Swal.fire({icon: 'success',title: 'Success!',text: 'The project was deleted successfully.'}).then(location.reload())
                    } else if(json.status = 403){
                        Swal.fire({icon: 'success',title: 'What?',text: 'You do not have permission to edit projects.'}).then(location.reload())
                    } else {
                        Swal.fire({icon: 'error',title: 'Oops...',text: 'There was an error adding this project'}).then(location.reload())
                    }
                })
            }

            function newProject() {
                let name = $("#f_name").val()
                let desc = $("#f_description").val()
                let link = $("#f_link").val()
                let image = $("#f_image").val()

                if(!name) return Swal.fire({icon: 'error',title: 'Oops...',text: 'Please fill out the form completely.'})
                if(!desc) return Swal.fire({icon: 'error',title: 'Oops...',text: 'Please fill out the form completely.'})
                if(!link) return Swal.fire({icon: 'error',title: 'Oops...',text: 'Please fill out the form completely.'})
                if(!image) return Swal.fire({icon: 'error',title: 'Oops...',text: 'Please fill out the form completely.'})

                $("#newcont").remove()
                $("#newact").remove()
                $("#newcard").append(' <div class="preloader-wrapper small active"><div class="spinner-layer spinner-green-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div</div></div>')
                fetch("https://api.stringy.software/database/projects", {
                    method: "post",
                    headers: {
                        "X-DiscordToken": Cookies.get("access_token"),
                        "Content-Type": 'application/json'
                    },
                    "body": JSON.stringify({
                        "name": name,
                        "description": desc,
                        "link": link,
                        "image": image
                    })
                })
                .then(res => res.json())
                .then(json => {
                    if(json.status = 200){
                        Swal.fire({icon: 'success',title: 'Success!',text: 'The project was added successfully.'}).then(location.reload())
                    } else if(json.status = 403){
                        Swal.fire({icon: 'success',title: 'What?',text: 'You do not have permission to edit projects.'}).then(location.reload())
                    } else {
                        Swal.fire({icon: 'error',title: 'Oops...',text: 'There was an error adding this project'}).then(location.reload())
                    }
                })
            }

            $(window).on('load', function(){
                fetch("https://discordapp.com/api/users/@me", {
                    method: 'get',
                    headers: {
                        authorization: `${Cookies.get("token_type")} ${Cookies.get("access_token")}`
                    }
                })
                .then(res => res.json())
                .then(userInfo =>{
                    // Change the pfp thingy
                    $("#profile").attr("src", `https://cdn.discordapp.com/avatars/${userInfo.id}/${userInfo.avatar}`)
                    $("#loginlink").remove()
                })

                fetch("https://api.stringy.software/database/projects")
                .then(res => res.json())
                .then(projects => {
                    for(var i = 0; i < projects.length; i++){
                        let html =`<div class="col s4 card transparent"><div class="card-image"><img src="${projects[i].image}"><span class="card-title">${projects[i].name}</span></div><div class="card-content"><p>${projects[i].description}</p></div><div class="card-action"><a href="${projects[i].link}">Go</a></div></div>`
                        $("#projects").append(html)
                    }
                })

                // $.ajax({url: "https://api.stringy.software/database/profile", headers:{"X-DiscordToken": Cookies.get("access_token")}, success: function(json){
                //     if(json[0].administrator === 1){
                //         $("#editcont").append('<a class="waves-effect waves-light btn">Edit</a>')
                //     }
                // }})

                fetch("https://api.stringy.software/database/profile", {
                    method: 'get',
                    headers: {
                        "X-DiscordToken": Cookies.get("access_token")
                    }
                })
                .then(res => res.json())
                .then(json => {
                    if(json[0].administrator === 1){
                        $("#editcont").append('<a id="editbtn" href="javascript:editprojects()" class="waves-effect waves-light btn">Edit</a>')
                    }
                })
            })
        </script>
    </body>
</html>